<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>V8 Map对象学习 | Small Utopia</title><meta name="author" content="Eutopia"><meta name="copyright" content="Eutopia"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="学习一下V8的Map对象，以下基本为对参考链接的文章的翻译转载。 引入ECMAScript 2015，也被成为ES6，引入了很多内置类型，例如Map、Set、WeakMap、WeakSet。他们是对标准JS库的扩展并在其他库，应用以及Node.js Core中广泛使用。今天我们关注于Map类型并且尝试去理解V8中的该类型实现细节，同时做一些总结。规范并没有规定用于实现Map类型的精确算法，而是为可">
<meta property="og:type" content="article">
<meta property="og:title" content="V8 Map对象学习">
<meta property="og:url" content="https://eknight-eutopia.github.io/posts/f97d3541.html">
<meta property="og:site_name" content="Small Utopia">
<meta property="og:description" content="学习一下V8的Map对象，以下基本为对参考链接的文章的翻译转载。 引入ECMAScript 2015，也被成为ES6，引入了很多内置类型，例如Map、Set、WeakMap、WeakSet。他们是对标准JS库的扩展并在其他库，应用以及Node.js Core中广泛使用。今天我们关注于Map类型并且尝试去理解V8中的该类型实现细节，同时做一些总结。规范并没有规定用于实现Map类型的精确算法，而是为可">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://eknight-eutopia.github.io/img/cover/default_cover%20(3).jpg">
<meta property="article:published_time" content="2025-09-08T16:00:00.000Z">
<meta property="article:modified_time" content="2025-11-06T09:33:30.344Z">
<meta property="article:author" content="Eutopia">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://eknight-eutopia.github.io/img/cover/default_cover%20(3).jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://eknight-eutopia.github.io/posts/f97d3541.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        if (name && globalFn[key][name]) return
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b2bb076b3ca994b59d55f4681f7e3427";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
btf.addGlobalFn('pjaxComplete', () => {
  _hmt.push(['_trackPageview',window.location.pathname])
}, 'baidu_analytics')
</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400,"highlightFullpage":true,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'V8 Map对象学习',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-11-06 17:33:30'
}</script><link rel="stylesheet" href="/config/css/transparancy.css"><link rel="stylesheet" href="/config/css/edit-icon-anime.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(/img/background.png);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">110</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">55</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-blog"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/sitetime"><i class="fa-fw fas fa-hourglass-end"></i><span> 时间轴</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw far fa-paper-plane"></i><span> 关于</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background: transparent;"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Small Utopia</span></a><a class="nav-page-title" href="/"><span class="site-name">V8 Map对象学习</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-blog"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/sitetime"><i class="fa-fw fas fa-hourglass-end"></i><span> 时间轴</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-heartbeat"></i><span> 清单</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw far fa-paper-plane"></i><span> 关于</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">V8 Map对象学习</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-09-08T16:00:00.000Z" title="发表于 2025-09-09 00:00:00">2025-09-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-11-06T09:33:30.344Z" title="更新于 2025-11-06 17:33:30">2025-11-06</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">1.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>6分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>学习一下V8的Map对象，以下基本为对参考链接的文章的翻译转载。</p>
<h2 id="引入"><a href="#引入" class="headerlink" title="引入"></a>引入</h2><p>ECMAScript 2015，也被成为ES6，引入了很多内置类型，例如Map、Set、WeakMap、WeakSet。他们是对标准JS库的扩展并在其他库，应用以及Node.js Core中广泛使用。今天我们关注于Map类型并且尝试去理解V8中的该类型实现细节，同时做一些总结。<br>规范并没有规定用于实现Map类型的精确算法，而是为可能的实现以及预期的性能特征提供了一些建议：</p>
<blockquote>
<p>Map object must be implemented using either hash tables or other mechanisms that, on average, provide access times that are sublinear on the number of elements in the collection. The data structures used in this Map objects specification is only intended to describe the required observable semantics of Map objects. It is not intended to be a viable implementation model.</p>
</blockquote>
<p>可以看到，该规范为实现保留了很大的空间。在Java中的Map类型存在多种实现接口，甚至可以微调该类型。<br>声明：该文章针对V8版本对8.4，以及Node.js（commit 238104c）</p>
<h2 id="底层算法概述"><a href="#底层算法概述" class="headerlink" title="底层算法概述"></a>底层算法概述</h2><p>首先，V8的Maps是建立在hash tables基础上实现的。以下假设你已经理解了hash tables是如何工作的。如果你不熟悉该概念，那么可以参考<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Hash_table">wiki</a>学习。<br>如果你对于Maps类型有足够的经验，那么你会发现一个矛盾。Hash tables不提供顺序保证，但是ES6规范要求提供插入顺序保证。因此经典的算法并不适合Maps，但是通过微调仍然可以实现。<br>V8使用“deterministic hash tables algorithm”来实现Maps。以下TypeScript伪代码展示了该算法的主要数据结构</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Entry</span> &#123;</span><br><span class="line">	<span class="attr">key</span>: <span class="built_in">any</span>;</span><br><span class="line">	<span class="attr">value</span>: <span class="built_in">any</span>;</span><br><span class="line">	<span class="attr">chain</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">CloseTable</span> &#123;</span><br><span class="line">	<span class="attr">hashTable</span>: <span class="built_in">number</span>[];</span><br><span class="line">	<span class="attr">dataTable</span>: <span class="title class_">Entry</span>[];</span><br><span class="line">	<span class="attr">nextSlot</span>: <span class="built_in">number</span>;</span><br><span class="line">	<span class="attr">size</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里<code>CloseTable</code>接口表示hash table。其包含hashTable数组，其大小与buckets大小相同。数组第N个元素表示第N个bucket，并且在dataTable数组中维护了bucket头元素的index值。dataTable数组包含了以插入顺序排布的Entry元素。最终每个Entry有chain属性，其指向了在bucket链中的下一个entry。<br>每次一个新的entry插入到CloseTable时，其会存储在dataTable数组的<code>nextSlot</code>索引位置。还需要更新对应的bucket链，将插入的entry置于链末尾。<br>当一个entry从hash table中删除时，其从dataTable中删除（eg：将key和value设置为<code>undefined</code>）。注：删除元素仍然占据着<code>dataTable</code>的空间，不会进行释放回收。<br>最后一部分，当table装满时，会申请一个更大的空间，并进行重新哈希排布。<br>这样，遍历Map只需遍历dataTable数组。保证了Maps的有序性质。</p>
<h2 id="实际算法"><a href="#实际算法" class="headerlink" title="实际算法"></a>实际算法</h2><p>来一些例子来解释该算法是如何工作的。假设我们有一个包含两个buckets且总容量为4的<code>CloseTable</code>对象（hashTable.length&#x3D;2，datatable.length&#x3D;4）。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// let&#x27;s assume that we use identity hash function,</span></span><br><span class="line"><span class="comment">// i.e. function hashCode(n) &#123;return n;&#125;</span></span><br><span class="line">table.<span class="title function_">set</span>(<span class="number">0</span>, <span class="string">&#x27;a&#x27;</span>); <span class="comment">// =&gt; bucket 0 (0 % 2)</span></span><br><span class="line">table.<span class="title function_">set</span>(<span class="number">1</span>, <span class="string">&#x27;b&#x27;</span>); <span class="comment">// =&gt; bucket 1 (1 % 2)</span></span><br><span class="line">table.<span class="title function_">set</span>(<span class="number">2</span>, <span class="string">&#x27;c&#x27;</span>); <span class="comment">// =&gt; bucket 0 (0 % 2)</span></span><br></pre></td></tr></table></figure>
<p>在该例子中，内部table的内容如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> tableInternals = &#123;</span><br><span class="line">	<span class="attr">hashTable</span>: [<span class="number">0</span>, <span class="number">1</span>],</span><br><span class="line">	<span class="attr">dataTable</span>: [</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="attr">key</span>: <span class="number">0</span>,</span><br><span class="line">		<span class="attr">value</span>: <span class="string">&#x27;a&#x27;</span>,</span><br><span class="line">		<span class="attr">chain</span>: <span class="number">2</span> <span class="comment">// index of &lt;2, &#x27;c&#x27;&gt;</span></span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="attr">key</span>: <span class="number">1</span>,</span><br><span class="line">		<span class="attr">value</span>: <span class="string">&#x27;b&#x27;</span>,</span><br><span class="line">		<span class="attr">chain</span>: -<span class="number">1</span> <span class="comment">// means tail entry</span></span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="attr">key</span>: <span class="number">2</span>,</span><br><span class="line">		<span class="attr">value</span>: <span class="string">&#x27;c&#x27;</span>,</span><br><span class="line">		<span class="attr">chain</span>: -<span class="number">1</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="comment">// empty slot</span></span><br><span class="line">	],</span><br><span class="line">	<span class="attr">nextSlot</span>: <span class="number">3</span>, <span class="comment">// points to the empty slot</span></span><br><span class="line">	<span class="attr">size</span>: <span class="number">3</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果我们删除一个entry（table.delete(0)），table内容如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> tableInternals = &#123;</span><br><span class="line">	<span class="attr">hashTable</span>: [<span class="number">0</span>, <span class="number">1</span>],</span><br><span class="line">	<span class="attr">dataTable</span>: [</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="attr">key</span>: <span class="literal">undefined</span>, <span class="comment">// deleted entry</span></span><br><span class="line">		<span class="attr">value</span>: <span class="literal">undefined</span>,</span><br><span class="line">		<span class="attr">chain</span>: <span class="number">2</span></span><br><span class="line">	&#125;</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="attr">key</span>: <span class="number">1</span>,</span><br><span class="line">		<span class="attr">value</span>: <span class="string">&#x27;b&#x27;</span>,</span><br><span class="line">		<span class="attr">chain</span>: -<span class="number">1</span> <span class="comment">// means tail entry</span></span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="attr">key</span>: <span class="number">2</span>,</span><br><span class="line">		<span class="attr">value</span>: <span class="string">&#x27;c&#x27;</span>,</span><br><span class="line">		<span class="attr">chain</span>: -<span class="number">1</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="comment">// empty slot</span></span><br><span class="line">	],</span><br><span class="line">	<span class="attr">nextSlot</span>: <span class="number">3</span>, <span class="comment">// points to the empty slot</span></span><br><span class="line">	<span class="attr">size</span>: <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果我们继续插入两个新的entry，hash table则需要进行rehash，申请更大内存。<br>Sets使用的算法与之类似。仅有的区别为Set类型不需要value属性。</p>
<h2 id="算法实现细节"><a href="#算法实现细节" class="headerlink" title="算法实现细节"></a>算法实现细节</h2><p>C++语言编写并暴露给JS代码使用。主要部分定义在<code>OrderdHashTable</code>和<code>OrderedHashMap</code>类中。<br>对应代码实现：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/nodejs/node/blob/238104c531219db05e3421521c305404ce0c0cce/deps/v8/src/objects/ordered-hash-table.h">orderd-hash-table.h</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/nodejs/node/blob/238104c531219db05e3421521c305404ce0c0cce/deps/v8/src/objects/ordered-hash-table.cc">orderd-hash-table.cc</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/nodejs/node/blob/238104c531219db05e3421521c305404ce0c0cce/deps/v8/src/builtins/builtins-collections-gen.cc">buildins-collections-gen.cc</a></li>
</ul>
<h3 id="容量大小"><a href="#容量大小" class="headerlink" title="容量大小"></a>容量大小</h3><p>在V8中，hash table（Map）的大小总是2的指数倍。即表的最大容量为<code>2 * number_of_buckets</code>。当你创建一个空Map对象时，其hash table有两个buckets。因此其大小为4个entry。<br>最大容量有限制，在64位系统中最大为2^27，即不能超过16.7M个entries。<br>grow&#x2F;shrink因子则是2。每次double或除2.<br>作者添加了一些修改逻辑使得可以打印出Maps的容量。<br>运行以下script：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> map = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line"><span class="keyword">let</span> prevBuckets = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">	<span class="keyword">if</span> (prevBuckets !== map.<span class="property">buckets</span>) &#123;</span><br><span class="line">		<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`size: <span class="subst">$&#123;i&#125;</span>, buckets: <span class="subst">$&#123;map.buckets&#125;</span>, capacity: <span class="subst">$&#123;map.buckets * <span class="number">2</span>&#125;</span>`</span>);</span><br><span class="line">		prevBuckets = map.<span class="property">buckets</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	map.<span class="title function_">set</span>(&#123;&#125;, &#123;&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果如下，验证上述增长过程：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">|$ ./node /home/puzpuzpuz/map-grow-capacity.js|</span><br><span class="line">|size: 0, buckets: 2, capacity: 4|</span><br><span class="line">|size: 5, buckets: 4, capacity: 8|</span><br><span class="line">|size: 9, buckets: 8, capacity: 16|</span><br><span class="line">|size: 17, buckets: 16, capacity: 32|</span><br><span class="line">|size: 33, buckets: 32, capacity: 64|</span><br><span class="line">|size: 65, buckets: 64, capacity: 128|</span><br></pre></td></tr></table></figure>
<p>map对象大小缩小也是同理：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">|<span class="keyword">const</span> map = <span class="keyword">new</span> <span class="title class_">Map</span>();|</span><br><span class="line">|<span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;|</span><br><span class="line">|map.<span class="title function_">set</span>(i, i);|</span><br><span class="line">|&#125;|</span><br><span class="line">|<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`initial size: <span class="subst">$&#123;map.size&#125;</span>, buckets: <span class="subst">$&#123;map.buckets&#125;</span>, capacity: <span class="subst">$&#123;map.buckets * <span class="number">2</span>&#125;</span>`</span>);|</span><br><span class="line">||</span><br><span class="line">|<span class="keyword">let</span> prevBuckets = <span class="number">0</span>;|</span><br><span class="line">|<span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;|</span><br><span class="line">|map.<span class="title function_">delete</span>(i);|</span><br><span class="line">|<span class="keyword">if</span> (prevBuckets !== map.<span class="property">buckets</span>) &#123;|</span><br><span class="line">|<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`size: <span class="subst">$&#123;map.size&#125;</span>, buckets: <span class="subst">$&#123;map.buckets&#125;</span>, capacity: <span class="subst">$&#123;map.buckets * <span class="number">2</span>&#125;</span>`</span>);|</span><br><span class="line">|prevBuckets = map.<span class="property">buckets</span>;|</span><br><span class="line">|&#125;|</span><br><span class="line">|&#125;|</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">|$ ./node /home/puzpuzpuz/map-shrink-capacity.js|</span><br><span class="line">|initial size: 100, buckets: 64, capacity: 128|</span><br><span class="line">|size: 99, buckets: 64, capacity: 128|</span><br><span class="line">|size: 31, buckets: 32, capacity: 64|</span><br><span class="line">|size: 15, buckets: 16, capacity: 32|</span><br><span class="line">|size: 7, buckets: 8, capacity: 16|</span><br><span class="line">|size: 3, buckets: 4, capacity: 8|</span><br><span class="line">|size: 1, buckets: 2, capacity: 4|</span><br></pre></td></tr></table></figure>

<h3 id="哈希函数"><a href="#哈希函数" class="headerlink" title="哈希函数"></a>哈希函数</h3><p>迄今为止，我们还没有讨论V8如何计算key键值的哈希值。<br>对于数值类变量而言（Smis，heap类数值，大整数等等），使用低碰撞概率的<a target="_blank" rel="noopener" href="https://github.com/nodejs/node/blob/238104c531219db05e3421521c305404ce0c0cce/deps/v8/src/utils/utils.h#L213">hash function</a><br>对于字符类值（字符串，符号），基于字符串内容计算hash<br>对于对象，基于一个随机数计算哈希值。</p>
<h3 id="时间复杂度"><a href="#时间复杂度" class="headerlink" title="时间复杂度"></a>时间复杂度</h3><p>大多数Map操作，set、delete，需要查表，类似于哈希表，时间复杂度为O(1)。<br>rehashing操作为O(N)时间复杂度。</p>
<h3 id="内存占用"><a href="#内存占用" class="headerlink" title="内存占用"></a>内存占用</h3><p>保存在堆上。整个Map对象保存在一个固定长度的数组（一个元素占用8字节）上。数组由如下布局：</p>
<img src="/posts/f97d3541/file-20250909161516361.png" class="">
<p>头部包含了一些元数据信息。</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://itnext.io/v8-deep-dives-understanding-map-internals-45eb94a183df">[V8 Deep Dives] Understanding Map Internals</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://eknight-eutopia.github.io">Eutopia</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://eknight-eutopia.github.io/posts/f97d3541.html">https://eknight-eutopia.github.io/posts/f97d3541.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://eknight-eutopia.github.io" target="_blank">Small Utopia</a>！</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/img/cover/default_cover%20(3).jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/332a3199.html" title="V8-Hole漏洞"><img class="cover" src="/img/cover/default_cover%20(25).jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">V8-Hole漏洞</div></div><div class="info-2"><div class="info-item-1">对于V8 Hole相关内容的学习V8 Map对象的分析可以看这篇搬运：V8-Map对象 V8源码分析在v8中，JSMap的内存布局如下：   Map：每个对象会有的，包含对象属性的shape； FixedArray Length：整个OrderdHashMap的大小 elements：存在的entry的数量 deleteds：删除的entry数量 buckets：buckets数量考虑如下代码：12345678910111213141516171819var map = new Map();    %DebugPrint(map);  readline();    map.set(1, 1);  map.set(2, 1);  map.set(3, 1);  map.set(4, 1);  %DebugPrint(map);  readline();    map.delete(3);  %DebugPrint(map);  readline();    map.set(5, 1);  %DebugPrint(map); ...</div></div></div></a><a class="pagination-related" href="/posts/c9056bfc.html" title="LibAFL论文笔记"><img class="cover" src="/img/cover/default_cover%20(14).jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">LibAFL论文笔记</div></div><div class="info-2"><div class="info-item-1">论文概述本文提出一个新的工具LibAFL，旨在将AFL工具模块化，方便后续各项工作以及改进的集成。 看论文似乎AFL++也提供了高度配置化的模糊测试框架，但是不够通用 拟解决问题 正交性质的工作难以整合集成； 论文个体贡献难以评估：因为无法判断是基于的工具的优势还是创新算法的优势 难以比较不同工作；  论文贡献提出LibAFL，基于Rust实现的模糊测试框架。LibAFL包含了一系列的库可以用于定制化fuzzer。几个特性：  易于扩展； 按现在的fuzzer组成部分划分 Rust编写 实现了大量的模糊测试算法，特性以及插桩选项  背景关于fuzzing的定义：  Therefore, we believe it is more appropriate today to think of fuzzing as a family of testing techniques, which repeatedly provide machine-generated inputs to a target system with the aim of finding inputs that...</div></div></div></a></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E5%85%A5"><span class="toc-number">1.</span> <span class="toc-text">引入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%95%E5%B1%82%E7%AE%97%E6%B3%95%E6%A6%82%E8%BF%B0"><span class="toc-number">2.</span> <span class="toc-text">底层算法概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E7%AE%97%E6%B3%95"><span class="toc-number">3.</span> <span class="toc-text">实际算法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82"><span class="toc-number">4.</span> <span class="toc-text">算法实现细节</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%B9%E9%87%8F%E5%A4%A7%E5%B0%8F"><span class="toc-number">4.1.</span> <span class="toc-text">容量大小</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%93%88%E5%B8%8C%E5%87%BD%E6%95%B0"><span class="toc-number">4.2.</span> <span class="toc-text">哈希函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6"><span class="toc-number">4.3.</span> <span class="toc-text">时间复杂度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%8D%A0%E7%94%A8"><span class="toc-number">4.4.</span> <span class="toc-text">内存占用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">5.</span> <span class="toc-text">参考链接</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background: transparent;"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2025 By Eutopia</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>(() => {
  const initGitalk = () => {
    const gitalk = new Gitalk(Object.assign({
      clientID: '4c4d7e363cc61fad04a9',
      clientSecret: '93995fa6ff1a993b19e99287b2c362230cb33f11',
      repo: 'eknight-eutopia.github.io',
      owner: 'Eknight-Eutopia',
      admin: ['Eknight-Eutopia'],
      id: '71e1cd51e1984e6e5aad58065945eef4',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async() => {
    if (typeof Gitalk === 'function') initGitalk()
    else {
      await btf.getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
      await btf.getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js')
      initGitalk()
    }
  }
  
  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  if ('Gitalk' === 'Gitalk' || !false) {
    if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>